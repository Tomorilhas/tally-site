<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tally Externa</title>
  <style>
    /* ... (mant√©m o mesmo CSS anterior) ... */
  </style>
</head>
<body>
  <!-- ... (mant√©m o mesmo HTML anterior) ... -->

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    // Gera um ID √∫nico para o cliente (sess√£o)
    const CLIENT_ID = 'client_' + Math.random().toString(36).substr(2, 9);

    const brokerUrl = "wss://2ca26723bea1429ab8136fa9d24ea28d.s1.eu.hivemq.cloud:8884/mqtt";
    const options = {
      username: "morilhas",
      password: "Pi3,1415",
      connectTimeout: 4000,
      reconnectPeriod: 4000,
      clean: true
    };

    const client = mqtt.connect(brokerUrl, options);
    const statusDiv = document.getElementById("status-mqtt");
    const menuDiv = document.getElementById("menu");
    const backBtn = document.getElementById("back-btn");
    const statusLabel = document.getElementById("status-label");
    const externaInfo = document.getElementById("externa-info");
    const lastUpdateDiv = document.getElementById("last-update");

    let currentExterna = null;
    let externasStatus = {};
    let lastUpdate = {};
    let clientsInExterna = {}; // { '1': [clientId1, clientId2], ... }

    // --- WAKE LOCK: manter tela ativa ---
    let wakeLock = null;
    async function ativarTelaSempreLigada() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
            // Wake Lock liberada
          });
        } catch (err) {
          // Falha ao requisitar wake lock (talvez permiss√£o, ou n√£o suportado)
        }
      }
    }
    async function liberarTelaSempreLigada() {
      if (wakeLock) {
        try {
          await wakeLock.release();
        } catch (err) {}
        wakeLock = null;
      }
    }
    // -----------------------------------

    // Subscribe nos t√≥picos de status e clients
    client.on("connect", () => {
      statusDiv.textContent = "‚úÖ Conectado ao MQTT";
      for (let i = 1; i <= 5; i++) {
        client.subscribe(`externa/${i}/status`);
        client.subscribe(`externa/${i}/clients`);
      }
    });

    client.on("error", (err) => {
      statusDiv.textContent = "‚ùå Erro na conex√£o MQTT";
      console.error("MQTT Error:", err);
    });

    client.on("close", () => {
      statusDiv.textContent = "üîå Conex√£o fechada!";
    });

    client.on("offline", () => {
      statusDiv.textContent = "‚ö†Ô∏è Cliente offline";
    });

    client.on("reconnect", () => {
      statusDiv.textContent = "Tentando reconectar...";
    });

    client.on("message", (topic, message) => {
      // Status das externas
      if (topic.match(/^externa\/\d+\/status$/)) {
        const externaNum = topic.split("/")[1];
        const status = message.toString().trim().toUpperCase();
        externasStatus[externaNum] = status;
        lastUpdate[externaNum] = new Date();
        updateButtons();
        updateStatusLabel();
        if (currentExterna) {
          const data = lastUpdate[currentExterna];
          if (data) {
            lastUpdateDiv.textContent = "√öltima atualiza√ß√£o: " + data.toLocaleTimeString("pt-BR");
          }
        }
      }
      // Gerenciamento dos clientes conectados em cada externa
      if (topic.match(/^externa\/\d+\/clients$/)) {
        const externaNum = topic.split("/")[1];
        let msg = "";
        try {
          msg = JSON.parse(message.toString());
        } catch(e) { return; }
        if (!clientsInExterna[externaNum]) clientsInExterna[externaNum] = [];
        if (msg.action === "enter") {
          if (!clientsInExterna[externaNum].includes(msg.client))
            clientsInExterna[externaNum].push(msg.client);
        } else if (msg.action === "leave") {
          clientsInExterna[externaNum] = clientsInExterna[externaNum].filter(c => c !== msg.client);
        }
        updateButtons();
      }
    });

    function selectExterna(num) {
      // Publica presen√ßa no t√≥pico clients da externa
      currentExterna = num;
      client.publish(`externa/${num}/clients`, JSON.stringify({client: CLIENT_ID, action: "enter", timestamp: Date.now()}), {retain: false});
      menuDiv.style.display = "none";
      backBtn.style.display = "block";
      updateButtons();
      updateStatusLabel();
      updateExternaInfo();
      statusLabel.style.display = "block";
      externaInfo.style.display = "block";
      // Exibe imediatamente o status da √∫ltima mensagem recebida (retida)
      const status = (externasStatus[num] || "BY").toUpperCase();
      statusLabel.textContent = status;
      statusLabel.className = "";
      if (status === "PGM") {
        statusLabel.classList.add("pgm");
        document.body.style.backgroundColor = "#c00";
      } else if (status === "PW") {
        statusLabel.classList.add("pw");
        document.body.style.backgroundColor = "#0c0";
      } else {
        statusLabel.classList.add("by");
        document.body.style.backgroundColor = "#ccc";
      }
      // Atualiza hora imediatamente
      const data = lastUpdate[num];
      if (data) {
        lastUpdateDiv.textContent = "√öltima atualiza√ß√£o: " + data.toLocaleTimeString("pt-BR");
      } else {
        lastUpdateDiv.textContent = "";
      }
      ativarTelaSempreLigada();
    }

    function goBack() {
      if (currentExterna) {
        client.publish(`externa/${currentExterna}/clients`, JSON.stringify({client: CLIENT_ID, action: "leave", timestamp: Date.now()}), {retain: false});
      }
      currentExterna = null;
      menuDiv.style.display = "block";
      backBtn.style.display = "none";
      statusLabel.style.display = "none";
      externaInfo.style.display = "none";
      document.body.style.backgroundColor = "#ccc";
      lastUpdateDiv.textContent = "";
      updateButtons();
      liberarTelaSempreLigada();
    }

    // Atualiza visual dos bot√µes conforme status e presen√ßa
    function updateButtons() {
      for (let i = 1; i <= 5; i++) {
        const btn = document.getElementById("btn" + i);
        const status = (externasStatus[i] || "BY").toUpperCase();
        btn.classList.remove("pgm", "pw", "by", "selected");
        btn.textContent = `Externa ${i}`;
        if (status === "PGM") btn.classList.add("pgm");
        else if (status === "PW") btn.classList.add("pw");
        else btn.classList.add("by");

        // Verifica presen√ßa de outros clientes al√©m de mim
        const clients = clientsInExterna[i] || [];
        const otherClients = clients.filter(c => c !== CLIENT_ID);
        if (otherClients.length > 0) {
          btn.textContent += " (em uso)";
        }
        if (currentExterna == i) {
          btn.classList.add("selected");
        }
      }
    }

    function updateStatusLabel() {
      if (currentExterna) {
        const status = (externasStatus[currentExterna] || "BY").toUpperCase();
        statusLabel.style.display = "block";
        statusLabel.className = "";
        if (status === "PGM") {
          statusLabel.textContent = "PGM";
          statusLabel.classList.add("pgm");
          document.body.style.backgroundColor = "#c00";
        } else if (status === "PW") {
          statusLabel.textContent = "PW";
          statusLabel.classList.add("pw");
          document.body.style.backgroundColor = "#0c0";
        } else {
          statusLabel.textContent = "BY";
          statusLabel.classList.add("by");
          document.body.style.backgroundColor = "#ccc";
        }
      } else {
        statusLabel.style.display = "none";
        document.body.style.backgroundColor = "#ccc";
      }
    }

    function updateExternaInfo() {
      if (currentExterna) {
        externaInfo.style.display = "block";
        externaInfo.textContent = `Voc√™ est√° na Externa ${currentExterna}`;
      } else {
        externaInfo.style.display = "none";
      }
    }

    document.addEventListener('keydown', function(event) {
      if (event.key === "Escape" && currentExterna !== null) {
        goBack();
      }
    });

    window.addEventListener('beforeunload', function() {
      if (currentExterna) {
        client.publish(`externa/${currentExterna}/clients`, JSON.stringify({client: CLIENT_ID, action: "leave", timestamp: Date.now()}), {retain: false});
      }
      liberarTelaSempreLigada();
    });

    updateButtons();
    updateStatusLabel();
    updateExternaInfo();
  </script>
</body>
</html>
